<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="visited">
	<resultMap id="resultMapVisitedVo" type="VisitedVo">
		<result column="visited_no" property="visitedNo" />
		<result column="user_no" property="userNo" />
		<result column="group_no" property="groupNo" />
		<result column="group_name" property="groupName" />
		<result column="store_no" property="storeNo" />
		<result column="menu_no" property="menuNo" />
		<result column="visited_date" property="visitedDate" />
		<result column="menu_1st_cate_Name" property="menu1stCateName" />
		<result column="store_name" property="storeName" />
		<result column="menu_name" property="menuName" />
		<result column="select_month" property="selectMonth" />
		<result column="visit_count" property="visitCount" />
		<result column="group_order" property="groupOrder" />
	</resultMap>
	
   
   <!-- 달력 가게정보 띄우기 -->
   <select id="calendar" parameterType="VisitedVo" resultMap="resultMapVisitedVo">
         select to_char(v.visited_date,'Mon DD YYYY','NLS_DATE_LANGUAGE=ENGLISH')visited_date, 
                f1.menu_1st_cate_name, 
                g.group_name, 
                s.store_name, 
                m.menu_name, 
                gm.group_order 
         from visited v, 
              users u, 
              food_1st_category f1, 
              food_2nd_category f2, 
              menu m, 
              store s,  
              groups g ,
              group_member gm 
         where f1.menu_1st_cate_no = f2.menu_1st_cate_no 
               and f2.menu_2nd_cate_no = m.menu_2nd_cate_no 
               and m.menu_no = v.menu_no 
               and g.group_no = v.group_no 
               and gm.group_no = v.group_no 
               and u.user_no = v.user_no 
               and v.store_no = s.store_no 
               and to_char(v.visited_date,'YYMM')=to_char(to_date(${selectMonth},'YYMM'),'YYMM') 
               and v.user_no = #{userNo} 
         order by v.visited_date asc
   </select>
	
	
	<!-- 지니 -->
	<select id="recentVisit" parameterType="VisitedVo" resultMap="resultMapVisitedVo">
		SELECT  visit_count
				, visited_date
				, group_name
		FROM (SELECT count(visited_no) visit_count
			  FROM visited
			  WHERE store_no = #{storeNo}
			  AND user_no = #{userNo}), 
			 (SELECT TO_CHAR(visited_date, 'YYYY.MM.DD') visited_date
		         	 , group_name
			  FROM visited v, groups g
			  WHERE visited_no = (SELECT MAX(visited_no)
		                   		  FROM visited
		                    	  WHERE store_no = #{storeNo}
		                    	  AND user_no = #{userNo})
			  AND v.group_no = g.group_no) 
	</select>

</mapper>
